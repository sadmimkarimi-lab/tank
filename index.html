<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ§Ù†Ú© Ø°Ù‡Ù†ÛŒ Ø·Ø§ÙˆÛŒØªØ§ | Tavita Tank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/dist/font-face.css" rel="stylesheet" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family: Vazirmatn, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top,#111827,#020617);
      color:#f9fafb;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:16px;
    }

    .game-wrapper{
      width:100%;
      max-width:420px;
    }

    /* Ù‡Ø¯Ø± */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:8px;
    }

    .header-left{
      display:flex;
      gap:10px;
      font-size:12px;
    }
    .header-link{
      background:transparent;
      border:none;
      color:#e5e7eb;
      cursor:pointer;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid transparent;
      transition:all .15s;
      font-weight:500;
    }
    .header-link:hover{
      border-color:rgba(148,163,184,.8);
      background:rgba(15,23,42,.7);
    }

    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      text-align:right;
      gap:4px;
    }

    .logo-row{
      display:flex;
      flex-direction:row-reverse; /* Ù„ÙˆÚ¯Ùˆ Ø³Ù…Øª Ø±Ø§Ø³ØªØŒ Ø¹Ù†ÙˆØ§Ù† Ù…ÛŒâ€ŒÚ†Ø³Ø¨Ù‡ Ú©Ù†Ø§Ø±Ø´ */
      align-items:center;
      gap:8px;
    }

    .title-row{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .title-row span.icon{font-size:18px;}
    h1{
      font-size:18px;
      font-weight:800;
    }
    .subtitle{
      font-size:12px;
      opacity:.85;
    }

    .logo-badge{
      width:52px;
      height:52px;
      border-radius:16px;
      background:radial-gradient(circle at top,#38bdf8,#0f172a);
      box-shadow:0 0 18px rgba(56,189,248,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:18px;
      letter-spacing:1px;
      color:#e0faff;
      flex-shrink:0;
    }

    .game-panel{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000);
      border-radius:22px;
      padding:12px 12px 16px;
      box-shadow:0 16px 40px rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.3);
    }

    .canvas-wrap{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.35);
      margin-bottom:10px;
    }
    canvas{
      display:block;
      width:100%;
      height:auto;
    }

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      font-size:12px;
    }
    .stat-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.5);
    }
    .dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,.9);
    }
    .badge-level{
      background:rgba(59,130,246,.2);
      border-color:rgba(59,130,246,.7);
    }

    /* Ø§ÙˆÙˆØ±Ù„ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²ÛŒ */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      background:radial-gradient(circle at center,rgba(15,23,42,.35),rgba(15,23,42,.96));
      text-align:center;
      padding:14px;
      z-index:3;
    }
    .overlay.hidden{display:none;}
    .overlay h2{
      font-size:19px;
      margin-bottom:6px;
    }
    .overlay p{
      font-size:12px;
      opacity:.9;
      margin-bottom:10px;
      line-height:1.9;
    }
    .overlay button{
      border:none;
      border-radius:999px;
      padding:7px 18px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg,#ec4899,#6366f1);
      color:#fff;
      box-shadow:0 10px 26px rgba(129,140,248,.9);
      margin:2px;
    }
    .overlay .secondary{
      background:transparent;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:none;
    }

    /* Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ */
    .controls{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
      direction:ltr; /* ØªØ±ØªÛŒØ¨ Ú†Ù¾ â†’ Ø´Ù„ÛŒÚ© â†’ Ø±Ø§Ø³Øª */
    }
    .ctrl-btn{
      flex:1;
      padding:14px 0;
      border-radius:22px;
      border:none;
      cursor:pointer;
      font-size:20px;
      font-weight:700;
      background:linear-gradient(135deg,#0ea5e9,#3b82f6);
      color:#e0faff;
      box-shadow:0 8px 26px rgba(59,130,246,.45);
      transition:transform .1s;
    }
    .ctrl-btn:active{
      transform:scale(.9);
    }
    .ctrl-btn.fire{
      flex:1.4;
      background:linear-gradient(135deg,#f97316,#e11d48);
      box-shadow:0 10px 32px rgba(239,68,68,.6);
    }
    .hint{
      margin-top:6px;
      font-size:11px;
      opacity:.8;
      text-align:center;
    }

    /* Ù…ÙˆØ¯Ø§Ù„ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§ */
    .about-modal,
    .shop-modal{
      position:fixed;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      background:rgba(15,23,42,0.9);
      z-index:50;
    }
    .about-modal.hidden,
    .shop-modal.hidden{
      display:none;
    }
    .about-box,
    .shop-box{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000);
      border-radius:20px;
      padding:18px;
      max-width:380px;
      width:90%;
      border:1px solid rgba(148,163,184,0.45);
      box-shadow:0 18px 40px rgba(15,23,42,0.95);
      text-align:right;
    }
    .about-box h2,
    .shop-box h2{
      font-size:16px;
      margin-bottom:6px;
    }
    .about-box p,
    .shop-box p{
      font-size:12px;
      line-height:1.9;
      opacity:0.9;
      margin-bottom:10px;
    }
    .about-box button,
    .shop-box button{
      border:none;
      border-radius:999px;
      padding:6px 14px;
      font-size:12px;
      background:linear-gradient(135deg,#6366f1,#0ea5e9);
      color:#f9fafb;
      cursor:pointer;
    }

    .shop-items{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .shop-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:7px 10px;
      border-radius:12px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.6);
      font-size:12px;
    }
    .shop-item-info{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .shop-item-title{
      font-weight:600;
      font-size:13px;
    }
    .shop-item-desc{
      opacity:0.9;
      font-size:11px;
    }
    .shop-item button{
      padding:4px 10px;
      font-size:11px;
      border-radius:999px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
    }
    .shop-coins{
      font-size:12px;
      margin-bottom:4px;
      opacity:0.9;
    }

    @media(max-width:480px){
      h1{font-size:17px;}
      .subtitle{font-size:11px;}
      .logo-badge{width:48px;height:48px;}
    }
  </style>
</head>
<body>
  <div class="game-wrapper">
    <!-- Ù‡Ø¯Ø± -->
    <header class="header">
      <div class="header-left">
        <button class="header-link" id="aboutBtn">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§</button>
        <button class="header-link" id="shopBtn">ÙØ±ÙˆØ´Ú¯Ø§Ù‡</button>
      </div>
      <div class="header-right">
        <div class="logo-row">
          <div class="logo-badge">T</div>
          <div>
            <div class="title-row">
              <span class="icon">ğŸ§ </span>
              <h1>ØªØ§Ù†Ú© Ø°Ù‡Ù†ÛŒ Ø·Ø§ÙˆÛŒØªØ§</h1>
            </div>
            <div class="subtitle">Ø¨Ø§ ØªØ§Ù†Ú© Ú©Ø§Ø±ØªÙˆÙ†ÛŒâ€ŒØ§ØªØŒ Ù…Ø³ÛŒØ± Ø°Ù‡Ù† Ø±Ùˆ Ø§Ø² Ø¨Ø¯ÛŒâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒ.</div>
          </div>
        </div>
      </div>
    </header>

    <div class="game-panel">
      <div class="canvas-wrap">
        <canvas id="gameCanvas"></canvas>

        <!-- Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ -->
        <div id="startOverlay" class="overlay">
          <h2>ØªØ§Ù†Ú© Ø°Ù‡Ù† Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Øª ğŸš€</h2>
          <p>
            Ø¨Ø§ ØªØ§Ù†Ú© Ø·Ø§ÙˆÛŒØªØ§ Ø¯Ø± Ù…Ø³ÛŒØ± Ø­Ø±Ú©Øª Ú©Ù†ØŒ Ø¨Ù‡ Ø¨Ù„ÙˆÚ©â€ŒÙ‡Ø§ÛŒ Â«Ø¨Ø¯ÛŒâ€ŒÙ‡Ø§Â» Ø´Ù„ÛŒÚ© Ú©Ù† Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ù‡ Ø¬Ù„ÙˆÛŒ Ø±Ø´Ø¯ Ùˆ ØªÙ…Ø±Ú©Ø²Øª Ø±Ùˆ Ø¨Ú¯ÛŒØ±Ù†.<br>
            Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡ ÛŒÚ© Ù…ÙˆØ¶ÙˆØ¹ Ø°Ù‡Ù†ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø±Ù‡.
          </p>
          <button id="startBtn">Ø´Ø±ÙˆØ¹ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Û±</button>
          <button id="continueBtn" class="secondary">Ø§Ø¯Ø§Ù…Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡</button>
        </div>

        <!-- Ø§ØªÙ…Ø§Ù… Ù…Ø±Ø­Ù„Ù‡ -->
        <div id="levelOverlay" class="overlay hidden">
          <h2>Ù…Ø±Ø­Ù„Ù‡ ØªÙ…ÙˆÙ… Ø´Ø¯ âœ¨</h2>
          <p>
            Ø¢ÙØ±ÛŒÙ†! Ù…Ø³ÛŒØ± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø°Ù‡Ù† Ø±Ùˆ ØªÙ…ÛŒØ² Ú©Ø±Ø¯ÛŒ.<br>
            Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±ÛŒ Ø³Ø±Ø§Øº Ú†Ø§Ù„Ø´ Ø¨Ø¹Ø¯ÛŒØŸ
          </p>
          <button id="nextLevelBtn">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ â–¶ï¸</button>
        </div>

        <!-- Ø¨Ø§Ø®Øª -->
        <div id="gameOverOverlay" class="overlay hidden">
          <h2>Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ ğŸ’”</h2>
          <p>
            Ø§Ù…ØªÛŒØ§Ø² Ø§ÛŒÙ† Ø¯ÙˆØ±: <span id="finalScore">0</span><br>
            Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: <span id="bestScore">0</span>
          </p>
          <button id="restartBtn">Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Û±</button>
        </div>
      </div>

      <!-- Ø§Ù…ØªÛŒØ§Ø² / Ù…Ø±Ø­Ù„Ù‡ / Ø¬ÙˆÙ† -->
      <div class="top-bar">
        <span class="stat-pill">
          <span class="dot"></span>
          Ø§Ù…ØªÛŒØ§Ø²: <span id="score">0</span>
        </span>
        <span class="stat-pill badge-level">
          Ù…Ø±Ø­Ù„Ù‡: <span id="levelLabel">Û±</span>
        </span>
        <span class="stat-pill">
          â¤ï¸ <span id="lives">3</span>
        </span>
      </div>

      <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ -->
      <div class="controls">
        <button class="ctrl-btn" id="leftBtn">â—€ï¸</button>
        <button class="ctrl-btn fire" id="fireBtn">ğŸ”¥</button>
        <button class="ctrl-btn" id="rightBtn">â–¶ï¸</button>
      </div>
      <div class="hint">
        Ø±ÙˆÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±: Ø¨Ø§ â—€ï¸â–¶ï¸ Ø­Ø±Ú©Øª Ú©Ù†ØŒ Ø¨Ø§ Space Ø´Ù„ÛŒÚ© Ú©Ù†. | Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§ -->
  <div class="about-modal hidden" id="aboutModal">
    <div class="about-box">
      <h2>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§</h2>
      <p>
        Ø·Ø§ÙˆÛŒØªØ§ ÛŒÚ© ØªÛŒÙ… Ú©ÙˆÚ†Ú© Ø§Ù…Ø§ Ø¹Ø§Ø´Ù‚ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ‡Ø›
        Ù…Ø§ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… Ú©Ù‡ Ù‡Ù… Ø°Ù‡Ù† Ø±Ùˆ Ø¨Ù‡ Ú†Ø§Ù„Ø´ Ø¨Ú©Ø´Ù†ØŒ Ù‡Ù… Ø­Ø³ Ø±Ø´Ø¯ Ùˆ Ø­Ø§Ù„Ù Ø®ÙˆØ¨ Ø¨Ø¯Ù†.
        Â«ØªØ§Ù†Ú© Ø°Ù‡Ù†ÛŒ Ø·Ø§ÙˆÛŒØªØ§Â» ÛŒÚ©ÛŒ Ø§Ø² Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø³ÛŒØ±Ù Ø±Ø´Ø¯Ù‡.
      </p>
      <button id="aboutCloseBtn">Ø¨Ø§Ø´Ù‡</button>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ -->
  <div class="shop-modal hidden" id="shopModal">
    <div class="shop-box">
      <h2>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù‚Ø¯Ø±Øªâ€ŒÙ‡Ø§</h2>
      <p>Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ØªÙˆØ§Ù†Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡â€ŒØ§ÛŒ Ø¨Ú¯ÛŒØ±ÛŒ Ú©Ù‡ Ø§Ø­ØªÙ…Ø§Ù„ Ø§ÙØªØ§Ø¯Ù† Ù¾Ø§ÙˆØ±Ø¢Ù¾â€ŒÙ‡Ø§ Ø±Ùˆ Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒÚ©Ù†Ù‡.</p>
      <div class="shop-coins">Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§: <span id="coinsLabel">0</span></div>
      <div class="shop-items">
        <div class="shop-item">
          <div class="shop-item-info">
            <div class="shop-item-title">Ø´Ù„ÛŒÚ© Ø³Ù‡â€ŒØªØ§ÛŒÛŒ</div>
            <div class="shop-item-desc">ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø³Ù‡â€ŒØªØ§ Ù…ÛŒâ€ŒØ´Ù†Ø› Ø§Ø­ØªÙ…Ø§Ù„ Ù¾Ø§ÙˆØ±Ø¢Ù¾ Ã—Û³ Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
          </div>
          <button data-item="triple">Ø®Ø±ÛŒØ¯ (Ûµâ­)</button>
        </div>
        <div class="shop-item">
          <div class="shop-item-info">
            <div class="shop-item-title">Ø­ÙØ§Ø¸ Ø§Ù†Ø±Ú˜ÛŒ</div>
            <div class="shop-item-desc">Ø´ÛŒÙ„Ø¯ Ù…Ø­Ø§ÙØ¸ Ù‚ÙˆÛŒâ€ŒØªØ± Ùˆ Ú©Ù…ÛŒ Ø¨ÛŒØ´ØªØ± Ø¸Ø§Ù‡Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
          </div>
          <button data-item="shield">Ø®Ø±ÛŒØ¯ (Û´â­)</button>
        </div>
        <div class="shop-item">
          <div class="shop-item-info">
            <div class="shop-item-title">Ù…ÙˆØ´Ú© Ø²Ù…Ø§Ù†ÛŒ</div>
            <div class="shop-item-desc">Ù¾Ø§ÙˆØ±Ø¢Ù¾ Ø§Ø³Ù„ÙˆÙ…ÙˆØ´Ù† Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒØ¢ÛŒØ¯ØŒ Ú©Ù†ØªØ±Ù„ Ø°Ù‡Ù† Ø±Ø§Ø­Øªâ€ŒØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
          </div>
          <button data-item="slow">Ø®Ø±ÛŒØ¯ (Û³â­)</button>
        </div>
      </div>
      <div style="margin-top:10px; font-size:11px; opacity:.8;">
        * Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ Ø´Ù…Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´Ù† Ùˆ Ø®Ø±ÛŒØ¯Ù‡Ø§ Ø±ÙˆÛŒ Ù‡Ù…Ù‡â€ŒÛŒ Ø¯ÙˆØ±Ù‡Ø§ Ø§Ø«Ø± Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù†Ø¯.
      </div>
      <div style="margin-top:10px; text-align:left;">
        <button id="shopCloseBtn">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- ØµØ¯Ø§ Ø¨Ø±Ø§ÛŒ Ø¶Ø±Ø¨Ù‡ (Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ù†Ø¨Ø§Ø´Ù‡ØŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯) -->
  <audio id="hitSound" src="hit.mp3" preload="auto"></audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const scoreEl = document.getElementById("score");
    const livesEl = document.getElementById("lives");
    const levelLabel = document.getElementById("levelLabel");
    const startOverlay = document.getElementById("startOverlay");
    const levelOverlay = document.getElementById("levelOverlay");
    const gameOverOverlay = document.getElementById("gameOverOverlay");
    const startBtn = document.getElementById("startBtn");
    const continueBtn = document.getElementById("continueBtn");
    const nextLevelBtn = document.getElementById("nextLevelBtn");
    const restartBtn = document.getElementById("restartBtn");
    const finalScoreEl = document.getElementById("finalScore");
    const bestScoreEl = document.getElementById("bestScore");

    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");
    const fireBtn = document.getElementById("fireBtn");
    const hitSound = document.getElementById("hitSound");

    const aboutBtn = document.getElementById("aboutBtn");
    const shopBtn = document.getElementById("shopBtn");
    const aboutModal = document.getElementById("aboutModal");
    const aboutCloseBtn = document.getElementById("aboutCloseBtn");
    const shopModal = document.getElementById("shopModal");
    const shopCloseBtn = document.getElementById("shopCloseBtn");
    const coinsLabel = document.getElementById("coinsLabel");

    const shopItemButtons = shopModal.querySelectorAll(".shop-item button");

    // ØªØµØ§ÙˆÛŒØ± ØªØ§Ù†Ú© Ùˆ Ø¨Ø§Ø³
    const tankImg = new Image();
    tankImg.src = "https://cdnfa.com/irangiah/a9be/uploads/tank/tank.webp";

    const bossImg = new Image();
    bossImg.src = "https://cdnfa.com/irangiah/a9be/uploads/tank/ghool1.webp";

    function playHitSound() {
      if (!hitSound || !hitSound.src) return;
      try {
        hitSound.currentTime = 0;
        hitSound.play();
      } catch (e) {}
    }

    // Ø³Ø§ÛŒØ² Ú©Ø§Ù†ÙˆØ§Ø³
    function resizeCanvas(){
      const maxWidth = 420;
      const ratio = 9/16;
      const width = Math.min(maxWidth, window.innerWidth - 32);
      const height = width / ratio;
      canvas.width = width;
      canvas.height = height;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    // ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ
    let tank = { x:0,y:0,w:50,h:30,speed:4 };
    let bullets = [];
    let enemies = [];
    let powerUps = [];
    let particles = [];

    let score = 0;
    let lives = 3;
    let gameRunning = false;
    let lastTime = 0;
    let lastEnemyTime = 0;
    let lastPowerUpTime = 0;

    // Ø§ÙÚ©Øªâ€ŒÙ‡Ø§
    let hitFlash = 0;
    let shakeTime = 0;
    let bgOffset = 0;

    // Ø³Ø·Ø­â€ŒÙ‡Ø§
    const LEVELS = [
      { id:1, label:"Û± - ØªÙ†Ø¨Ù„ÛŒ",         goal:40,  enemySpeed:1.3, spawnInterval:1300, boss:true },
      { id:2, label:"Û² - ØªØ±Ø³",           goal:90,  enemySpeed:1.6, spawnInterval:1100, boss:true },
      { id:3, label:"Û³ - Ù†Ø§Ø§Ù…ÛŒØ¯ÛŒ (Ø¨Ø§Ø³)", goal:150, enemySpeed:1.8, spawnInterval:1000, boss:true }
    ];
    let currentLevelIndex = 0;
    let levelGoal = LEVELS[0].goal;
    let spawnInterval = LEVELS[0].spawnInterval;
    let enemyBaseSpeed = LEVELS[0].enemySpeed;
    let bossSpawned = false;
    let bossAlive = false;

    // Ù¾Ø§ÙˆØ±Ø¢Ù¾â€ŒÙ‡Ø§
    const POWER_TYPES = ["shield","triple","slow"];
    let activePowerUps = {
      shield:false,
      triple:false,
      slow:false
    };
    let powerTimers = {};

    // ÙØ±ÙˆØ´Ú¯Ø§Ù‡ / Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§
    let moveLeft = false;
    let moveRight = false;

    const badLabels = [
      "Ø¯Ø±ÙˆØº",
      "ØªÙ‡Ù…Øª",
      "ØºÛŒØ¨Øª",
      "Ù…Ø±Ø¯Ù…â€ŒØ¢Ø²Ø§Ø±ÛŒ",
      "Ú¯Ø±Ø§Ù†ÙØ±ÙˆØ´ÛŒ",
      "Ø¨ÛŒâ€ŒØ§Ø¯Ø¨ÛŒ",
      "Ø¯Ø´Ù†Ø§Ù…",
      "ØªÙ†Ø¨Ù„ÛŒ",
      "Ø­Ø³Ø§Ø¯Øª",
      "Ø¨ÛŒâ€ŒØ­ÛŒØ§ÛŒÛŒ",
      "Ø¨ÛŒâ€ŒØ­Ø¬Ø§Ø¨ÛŒ",
      "ØªØ±Ú© Ù†Ù…Ø§Ø²",
      "Ù‚Ø¶Ø§ÙˆØª",
      "Ø®ÙˆØ¯Ú©Ù…â€ŒØ¨ÛŒÙ†ÛŒ",
      "Ø®ÙˆØ¯Ø®ÙˆØ§Ù‡ÛŒ",
      "Ù„Ø¬Ø§Ø¬Øª",
      "Ú†Ø´Ù…â€ŒÙˆÙ‡Ù…â€ŒÚ†Ø´Ù…ÛŒ",
      "Ø­Ù‚â€ŒØ§Ù„Ù†Ø§Ø³",
      "Ø­ÛŒÙˆØ§Ù†â€ŒØ¢Ø²Ø§Ø±ÛŒ",
      "Ù‚Ù‡Ø±"
    ];

    const STORAGE_KEY = "tavita_tank_state";
    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      try{
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }
    function saveState(extra = {}){
      const prev = loadState() || {};
      const bestScore = Math.max(score, prev.bestScore || 0);
      const data = {
        bestScore,
        lastLevel: LEVELS[currentLevelIndex].id,
        shop: prev.shop || {
          triple:0,
          shield:0,
          slow:0,
          coins:0
        },
        ...extra
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    function applyLoadedState(){
      const saved = loadState();
      if(!saved){
        continueBtn.style.display = "none";
        return;
      }
      continueBtn.style.display = "inline-block";
    }

    // ÙØ±ÙˆØ´Ú¯Ø§Ù‡: Ú¯Ø±ÙØªÙ† / Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø´Ø§Ù¾
    function getShopState(){
      const saved = loadState();
      if(!saved || !saved.shop){
        return { triple:0, shield:0, slow:0, coins:0 };
      }
      return saved.shop;
    }
    function setShopState(shop){
      const saved = loadState() || {};
      saved.shop = shop;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
    }

    function getCoinsFromScore(s){
      // Ø®ÛŒÙ„ÛŒ Ø³Ø§Ø¯Ù‡: Ù‡Ø± Û³Û° Ø§Ù…ØªÛŒØ§Ø² = Û± Ø³ØªØ§Ø±Ù‡
      return Math.floor((s || 0) / 30);
    }

    function updateShopUI(){
      const shop = getShopState();
      const currentCoins = getCoinsFromScore(loadState()?.bestScore || score);
      coinsLabel.textContent = currentCoins;
    }

    // Ø±ÛŒØ³Øª Ø¨Ø§Ø²ÛŒ
    function resetGameState(startFromLevelIndex = 0){
      bullets = [];
      enemies = [];
      powerUps = [];
      particles = [];
      score = 0;
      lives = 3;
      bossSpawned = false;
      bossAlive = false;
      hitFlash = 0;
      shakeTime = 0;
      bgOffset = 0;

      currentLevelIndex = startFromLevelIndex;
      const lvl = LEVELS[currentLevelIndex];
      levelGoal = lvl.goal;
      spawnInterval = lvl.spawnInterval;
      enemyBaseSpeed = lvl.enemySpeed;
      levelLabel.textContent = lvl.label;
      scoreEl.textContent = score;
      livesEl.textContent = lives;

      tank.w = canvas.width * 0.16;
      tank.h = tank.w * 0.55;
      tank.x = canvas.width/2 - tank.w/2;
      tank.y = canvas.height - tank.h - 20;
    }

    // Ù…Ø³ØªØ·ÛŒÙ„ Ú¯ÙˆØ´Ù‡â€ŒÚ¯Ø±Ø¯
    function roundRect(ctx,x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.lineTo(x+w-r,y);
      ctx.quadraticCurveTo(x+w,y,x+w,y+r);
      ctx.lineTo(x+w,y+h-r);
      ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
      ctx.lineTo(x+r,y+h);
      ctx.quadraticCurveTo(x,y+h,x,y+h-r);
      ctx.lineTo(x,y+r);
      ctx.quadraticCurveTo(x,y,x+r,y);
      ctx.closePath();
    }

    // Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ + Ø®Ø·ÙˆØ· Ù…ØªØ­Ø±Ú©
    function drawBackground(){
      const grad = ctx.createRadialGradient(
        canvas.width/2, canvas.height*0.1, 20,
        canvas.width/2, canvas.height, canvas.height
      );
      grad.addColorStop(0,"#0b1120");
      grad.addColorStop(0.5,"#020617");
      grad.addColorStop(1,"#000");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.strokeStyle = "rgba(148,163,184,0.18)";
      ctx.lineWidth = 1;
      for(let i=0;i<8;i++){
        const y = (canvas.height - 20) - (i*26) + bgOffset;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(canvas.width,y);
        ctx.stroke();
      }
    }

    // ØªØ§Ù†Ú© (Ø¨Ø§ ØªØµÙˆÛŒØ±)
    function drawTank(){
      const {x,y,w,h} = tank;

      if(tankImg.complete && tankImg.naturalWidth){
        const ratio = tankImg.width / tankImg.height;
        let drawW = w * 1.2;
        let drawH = drawW / ratio;
        if(drawH > h*2){
          drawH = h*2;
          drawW = drawH * ratio;
        }
        const dx = x + (w - drawW)/2;
        const dy = y - (drawH - h);
        ctx.drawImage(tankImg, dx, dy, drawW, drawH);

        if(activePowerUps.shield){
          ctx.strokeStyle = "rgba(56,189,248,0.7)";
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(x+w/2, y+h/2, w*0.8, 0, Math.PI*2);
          ctx.stroke();
        }
        return;
      }

      // fallback ÙˆÚ©ØªÙˆØ±ÛŒ
      const grad = ctx.createLinearGradient(x,y,x+w,y+h);
      grad.addColorStop(0,"#38bdf8");
      grad.addColorStop(1,"#0f172a");
      ctx.fillStyle = grad;
      ctx.strokeStyle = "#7dd3fc";
      ctx.lineWidth = 2;
      roundRect(ctx,x,y,w,h,8);
      ctx.fill();
      ctx.stroke();

      const tw = w*0.65, th = h*0.45;
      const tx = x + (w - tw)/2;
      const ty = y - th + 6;
      const gradTurret = ctx.createLinearGradient(tx,ty,tx+tw,ty+th);
      gradTurret.addColorStop(0,"#4ade80");
      gradTurret.addColorStop(1,"#22c55e");
      ctx.fillStyle = gradTurret;
      roundRect(ctx,tx,ty,tw,th,6);
      ctx.fill();

      const bw = 9, bh = h*0.9;
      const bx = x + w/2 - bw/2;
      const by = ty - bh + 12;
      ctx.fillStyle = "#f9fafb";
      roundRect(ctx,bx,by,bw,bh,4);
      ctx.fill();

      ctx.fillStyle = "#22d3ee";
      ctx.beginPath();
      ctx.arc(x+w*0.23, y+h*0.3, 4, 0, Math.PI*2);
      ctx.arc(x+w*0.77, y+h*0.3, 4, 0, Math.PI*2);
      ctx.fill();

      if(activePowerUps.shield){
        ctx.strokeStyle = "rgba(56,189,248,0.7)";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(x+w/2, y+h/2, w*0.8, 0, Math.PI*2);
        ctx.stroke();
      }
    }

    // Ú¯Ù„ÙˆÙ„Ù‡â€ŒÙ‡Ø§
    function drawBullets(){
      bullets.forEach(b=>{
        const grad = ctx.createRadialGradient(
          b.x, b.y, 1,
          b.x, b.y, b.r
        );
        grad.addColorStop(0,"#fff");
        grad.addColorStop(1,"#f97316");
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
        ctx.fill();
      });
    }

    // Ø¯Ø´Ù…Ù†â€ŒÙ‡Ø§ (Ù†Ø§ÙÙØ±Ù… + Ø¨Ø§Ø³ Ø¨Ø§ ØªØµÙˆÛŒØ±)
    function drawEnemies(){
      enemies.forEach(e=>{
        ctx.save();
        const cx = e.x + e.w/2;
        const cy = e.y + e.h/2;
        ctx.translate(cx, cy);
        ctx.rotate(e.angle || 0);

        if(e.isBoss && bossImg.complete && bossImg.naturalWidth){
          const bw = e.w * 1.1;
          const bh = e.h * 2;
          ctx.drawImage(bossImg, -bw/2, -bh/2, bw, bh);

          ctx.fillStyle = "#0f172a";
          ctx.font = "bold 12px Vazirmatn, system-ui";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("Ø¨Ø§Ø³", 0, -bh/2 + 14);
          ctx.fillText("HP: " + e.hp, 0, bh/2 - 12);
        } else {
          const grad = ctx.createLinearGradient(-e.w/2,-e.h/2,e.w/2,e.h/2);
          grad.addColorStop(0,e.colorStart);
          grad.addColorStop(1,e.colorEnd);
          ctx.fillStyle = grad;
          ctx.strokeStyle = "rgba(15,23,42,0.9)";
          ctx.lineWidth = 2;
          roundRect(ctx,-e.w/2,-e.h/2,e.w,e.h,8);
          ctx.fill();
          ctx.stroke();

          ctx.fillStyle = "#0f172a";
          ctx.font = "bold 13px Vazirmatn, system-ui";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(e.label, 0, 0);
        }
        ctx.restore();
      });
    }

    // Ù¾Ø§Ø±ØªÛŒÚ©Ù„ Ø§Ù†ÙØ¬Ø§Ø±
    function drawParticles(){
      ctx.save();
      particles.forEach(p=>{
        ctx.globalAlpha = p.life / p.maxLife;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
        ctx.fill();
      });
      ctx.restore();
    }

    function createExplosion(cx,cy,color){
      for(let i=0;i<10;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 1 + Math.random()*2;
        particles.push({
          x:cx,
          y:cy,
          vx:Math.cos(angle)*speed,
          vy:Math.sin(angle)*speed,
          life:25,
          maxLife:25,
          color:color
        });
      }
    }

    // Ù¾Ø§ÙˆØ±Ø¢Ù¾â€ŒÙ‡Ø§
    function drawPowerUps(){
      powerUps.forEach(p=>{
        const {x,y,r,type} = p;
        let c1="#a855f7";
        if(type==="shield") c1="#22c55e";
        if(type==="triple") c1="#eab308";
        if(type==="slow")   c1="#38bdf8";
        const grad = ctx.createRadialGradient(x,y,1,x,y,r);
        grad.addColorStop(0,"#fff");
        grad.addColorStop(1,c1);
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(x,y,r,0,Math.PI*2);
        ctx.fill();

        ctx.font = "bold 11px Vazirmatn, system-ui";
        ctx.fillStyle = "#020617";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        let text = "";
        if(type==="shield") text = "ğŸ›¡";
        if(type==="triple") text = "Ã—3";
        if(type==="slow")   text = "â³";
        ctx.fillText(text,x,y);
      });
    }

    // Ø¯Ø´Ù…Ù† Ø¬Ø¯ÛŒØ¯
    function spawnEnemy(isBoss = false){
      if(isBoss){
        const w = canvas.width*0.45;
        const h = 40;
        const x = (canvas.width - w)/2;
        const y = -h - 10;
        enemies.push({
          x,y,w,h,
          speed: enemyBaseSpeed*0.9,
          colorStart:"#e11d48",
          colorEnd:"#f97316",
          label:"Ø¨Ø§Ø³",
          isBoss:true,
          hp:40,
          angle:0
        });
        bossAlive = true;
        return;
      }

      const laneCount = 5;
      const laneWidth = canvas.width / laneCount;
      const laneIndex = Math.floor(Math.random()*laneCount);
      const w = laneWidth*0.7;
      const h = 32;
      const x = laneIndex*laneWidth + (laneWidth - w)/2;
      const y = -h-8;

      const colors = [
        ["#f97316","#fb923c"],
        ["#22c55e","#4ade80"],
        ["#3b82f6","#6366f1"],
        ["#e11d48","#f97316"],
        ["#a855f7","#6366f1"]
      ];
      const pair = colors[Math.floor(Math.random()*colors.length)];
      const label = badLabels[Math.floor(Math.random()*badLabels.length)];

      enemies.push({
        x,y,w,h,
        speed: enemyBaseSpeed + Math.random()*0.6,
        colorStart: pair[0],
        colorEnd: pair[1],
        label,
        isBoss:false,
        angle:(Math.random()-0.5)*0.35 // Ù†Ø§ÙØ±Ù… Ú©Ø±Ø¯Ù†
      });
    }

    // Ù¾Ø§ÙˆØ±Ø¢Ù¾ Ø¬Ø¯ÛŒØ¯ (Ø¨Ø§ Ø§Ø«Ø± ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø±ÙˆÛŒ Ø§Ø­ØªÙ…Ø§Ù„â€ŒÙ‡Ø§)
    function spawnPowerUp(){
      const laneCount = 5;
      const laneWidth = canvas.width/laneCount;
      const laneIndex = Math.floor(Math.random()*laneCount);
      const x = laneIndex*laneWidth + laneWidth/2;
      const y = -15;
      const r = 13;

      const shop = getShopState();
      const wTriple = 1 + (shop.triple || 0);
      const wShield = 1 + (shop.shield || 0);
      const wSlow   = 1 + (shop.slow || 0);
      const total = wTriple + wShield + wSlow;
      let rnd = Math.random()*total;
      let type;
      if(rnd < wTriple) type = "triple";
      else if(rnd < wTriple + wShield) type = "shield";
      else type = "slow";

      powerUps.push({
        x,y,r,
        speed:1.1,
        type
      });
    }

    // Ø´Ù„ÛŒÚ©
    function fireBullet(){
      if(!gameRunning) return;
      const baseBullet = () => ({
        x: tank.x + tank.w/2,
        y: tank.y - 6,
        r: 7,
        speed: 6
      });

      if(activePowerUps.triple){
        bullets.push(
          {...baseBullet(), x: tank.x + tank.w*0.3},
          {...baseBullet(), x: tank.x + tank.w/2},
          {...baseBullet(), x: tank.x + tank.w*0.7}
        );
      }else{
        bullets.push(baseBullet());
      }
      if(navigator.vibrate){
        navigator.vibrate(15);
      }
    }

    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§ÙˆØ±Ø¢Ù¾
    function activatePowerUp(type){
      activePowerUps[type] = true;
      if(powerTimers[type]) clearTimeout(powerTimers[type]);
      powerTimers[type] = setTimeout(()=>{
        activePowerUps[type] = false;
      }, type==="shield" ? 8000 : 6000);
    }

    // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¯Ø§ÛŒØ±Ù‡â€“Ù…Ø³ØªØ·ÛŒÙ„
    function rectCircleCollide(cx,cy,cr, rx,ry,rw,rh){
      const testX = Math.max(rx, Math.min(cx, rx+rw));
      const testY = Math.max(ry, Math.min(cy, ry+rh));
      const distX = cx - testX;
      const distY = cy - testY;
      return (distX*distX + distY*distY) <= cr*cr;
    }

    // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù†Ø·Ù‚
    function update(){
      if(moveLeft)  tank.x -= tank.speed;
      if(moveRight) tank.x += tank.speed;
      tank.x = Math.max(4, Math.min(canvas.width - tank.w - 4, tank.x));

      const enemySpeedFactor = activePowerUps.slow ? 0.5 : 1;
      const enemySpawnFactor = activePowerUps.slow ? 1.4 : 1;

      bgOffset += 1.2 * enemySpeedFactor;
      if(bgOffset > 26) bgOffset -= 26;

      bullets.forEach(b => b.y -= b.speed);
      bullets = bullets.filter(b => b.y + b.r > 0);

      enemies.forEach(e => {
        e.y += e.speed * enemySpeedFactor;
      });

      powerUps.forEach(p => {
        p.y += p.speed;
      });
      powerUps = powerUps.filter(p => p.y - p.r < canvas.height + 10);

      particles.forEach(p=>{
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.03;
        p.life--;
      });
      particles = particles.filter(p=>p.life>0);

      const now = performance.now();
      if(now - lastEnemyTime > spawnInterval * enemySpawnFactor){
        const lvl = LEVELS[currentLevelIndex];
        if(lvl.boss){
          if(!bossSpawned && score >= lvl.goal*0.4){
            spawnEnemy(true);
            bossSpawned = true;
          }else if(!bossAlive){
            spawnEnemy(false);
          }
        }else{
          spawnEnemy(false);
        }
        lastEnemyTime = now;
      }

      if(now - lastPowerUpTime > 7000){
        spawnPowerUp();
        lastPowerUpTime = now;
      }

      // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ú¯Ù„ÙˆÙ„Ù‡ Ø¨Ø§ Ø¯Ø´Ù…Ù†
      bullets.forEach((b,bi)=>{
        enemies.forEach((e,ei)=>{
          if(rectCircleCollide(b.x,b.y,b.r, e.x,e.y,e.w,e.h)){
            bullets.splice(bi,1);
            const cx = e.x + e.w/2;
            const cy = e.y + e.h/2;
            createExplosion(cx,cy,e.colorStart);

            if(e.isBoss){
              e.hp -= 5;
              if(e.hp <= 0){
                enemies.splice(ei,1);
                bossAlive = false;
                score += 40;
                scoreEl.textContent = score;
              }
            }else{
              enemies.splice(ei,1);
              score += 5;
              scoreEl.textContent = score;
            }
          }
        });
      });

      // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ù¾Ø§ÙˆØ±Ø¢Ù¾ Ø¨Ø§ ØªØ§Ù†Ú©
      powerUps.forEach((p,pi)=>{
        if(rectCircleCollide(p.x,p.y,p.r, tank.x,tank.y,tank.w,tank.h)){
          activatePowerUp(p.type);
          powerUps.splice(pi,1);
          if(p.type === "shield" && navigator.vibrate) navigator.vibrate(25);
        }
      });

      // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¯Ø´Ù…Ù† Ø¨Ø§ ØªØ§Ù†Ú© / Ú©Ù
      enemies.forEach((e,ei)=>{
        const collideWithTank =
          e.x < tank.x + tank.w &&
          e.x + e.w > tank.x &&
          e.y < tank.y + tank.h &&
          e.y + e.h > tank.y;

        if(collideWithTank || e.y + e.h >= canvas.height - 5){
          enemies.splice(ei,1);

          if(activePowerUps.shield){
            activePowerUps.shield = false;
          }else{
            lives -= 1;
            livesEl.textContent = lives;

            hitFlash = 1;
            shakeTime = 10;
            playHitSound();
            if(navigator.vibrate) navigator.vibrate(80);

            if(lives <= 0){
              endGame();
              return;
            }
          }
        }
      });

      // Ù¾Ø§ÛŒØ§Ù† Ù…Ø±Ø­Ù„Ù‡
      const lvl = LEVELS[currentLevelIndex];
      const levelCleared = score >= lvl.goal && (!lvl.boss || (lvl.boss && !bossAlive));
      if(levelCleared){
        gameRunning = false;
        const prev = loadState() || {};
        const bestScore = Math.max(score, prev.bestScore || 0);
        saveState({ bestScore, lastLevel: LEVELS[currentLevelIndex].id, shop: getShopState() });
        levelOverlay.classList.remove("hidden");
      }
    }

    // Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ
    function gameLoop(ts){
      if(!gameRunning) return;
      const delta = ts - lastTime;
      lastTime = ts;

      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.save();
      if (shakeTime > 0) {
        const intensity = 4;
        const dx = (Math.random()*2 - 1)*intensity;
        const dy = (Math.random()*2 - 1)*intensity;
        ctx.translate(dx, dy);
        shakeTime--;
      }

      drawBackground();
      update();
      drawEnemies();
      drawPowerUps();
      drawParticles();
      drawBullets();
      drawTank();

      ctx.restore();

      if (hitFlash > 0) {
        const alpha = hitFlash * 0.45;
        const cx = tank.x + tank.w / 2;
        const cy = tank.y + tank.h / 2;
        const grad = ctx.createRadialGradient(
          cx, cy, 10,
          cx, cy, tank.w * 2.2
        );
        grad.addColorStop(0, `rgba(248,113,113,${alpha})`);
        grad.addColorStop(1, "rgba(248,113,113,0)");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        hitFlash -= 0.05;
      }

      requestAnimationFrame(gameLoop);
    }

    function startGame(fromLevelIndex = 0){
      resetGameState(fromLevelIndex);
      startOverlay.classList.add("hidden");
      levelOverlay.classList.add("hidden");
      gameOverOverlay.classList.add("hidden");
      gameRunning = true;
      lastTime = performance.now();
      lastEnemyTime = performance.now();
      lastPowerUpTime = performance.now();
      requestAnimationFrame(gameLoop);
    }

    function endGame(){
      gameRunning = false;
      finalScoreEl.textContent = score;
      const saved = loadState();
      const best = Math.max(score, saved?.bestScore || 0);
      bestScoreEl.textContent = best;
      const shop = getShopState();
      const data = {
        bestScore: best,
        lastLevel: LEVELS[currentLevelIndex].id,
        shop
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      gameOverOverlay.classList.remove("hidden");
    }

    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    startBtn.addEventListener("click", ()=>{ startGame(0); });

    continueBtn.addEventListener("click", ()=>{
      const saved = loadState();
      if(!saved){startGame(0);return;}
      const idx = LEVELS.findIndex(l => l.id === saved.lastLevel);
      const levelIndex = idx >= 0 ? idx : 0;
      startGame(levelIndex);
    });

    nextLevelBtn.addEventListener("click", ()=>{
      currentLevelIndex++;
      if(currentLevelIndex >= LEVELS.length){
        currentLevelIndex = 0;
      }
      startGame(currentLevelIndex);
    });

    restartBtn.addEventListener("click", ()=>{ startGame(0); });

    // Ú©ÛŒØ¨ÙˆØ±Ø¯
    document.addEventListener("keydown",(e)=>{
      if(e.code === "ArrowLeft") moveLeft = true;
      else if(e.code === "ArrowRight") moveRight = true;
      else if(e.code === "Space"){
        e.preventDefault();
        fireBullet();
      }
    });
    document.addEventListener("keyup",(e)=>{
      if(e.code === "ArrowLeft") moveLeft = false;
      else if(e.code === "ArrowRight") moveRight = false;
    });

    // Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø´ØªÙ† Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
    function bindHold(btn, cb){
      const start = (e)=>{e.preventDefault();cb(true);};
      const end   = (e)=>{e.preventDefault();cb(false);};
      btn.addEventListener("mousedown",start);
      btn.addEventListener("mouseup",end);
      btn.addEventListener("mouseleave",end);
      btn.addEventListener("touchstart",start,{passive:false});
      btn.addEventListener("touchend",end);
      btn.addEventListener("touchcancel",end);
    }
    bindHold(leftBtn,(v)=>{moveLeft=v;});
    bindHold(rightBtn,(v)=>{moveRight=v;});

    fireBtn.addEventListener("click",(e)=>{e.preventDefault();fireBullet();});
    fireBtn.addEventListener("touchstart",(e)=>{e.preventDefault();fireBullet();},{passive:false});

    // Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§ / ÙØ±ÙˆØ´Ú¯Ø§Ù‡
    aboutBtn.addEventListener("click", ()=>{
      aboutModal.classList.remove("hidden");
    });
    aboutCloseBtn.addEventListener("click", ()=>{
      aboutModal.classList.add("hidden");
    });

    shopBtn.addEventListener("click", ()=>{
      updateShopUI();
      shopModal.classList.remove("hidden");
    });
    shopCloseBtn.addEventListener("click", ()=>{
      shopModal.classList.add("hidden");
    });

    // Ø®Ø±ÛŒØ¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
    shopItemButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const item = btn.getAttribute("data-item");
        const saved = loadState() || {};
        const bestScore = saved.bestScore || 0;
        let coins = getCoinsFromScore(bestScore);
        let cost = 3;
        if(item==="shield") cost = 4;
        if(item==="triple") cost = 5;

        if(coins < cost){
          alert("Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§Øª Ú©Ù…Ù‡Ø› Ø¨Ø§ÛŒØ¯ Ú©Ù…ÛŒ Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø²ÛŒ Ú©Ù†ÛŒ Ùˆ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ú¯ÛŒØ±ÛŒ.");
          return;
        }
        const shop = getShopState();
        shop[item] = (shop[item] || 0) + 1;
        // Ø³ØªØ§Ø±Ù‡ Ú©Ù… Ú©Ø±Ø¯Ù† Ø±Ùˆ ÙÙ‚Ø· Ù†Ù…Ø§Ø¯ÛŒÙ† Ù…ÛŒâ€ŒÚ¯ÛŒÙ…Ø› ÙØ¹Ù„Ø§Ù‹ Ø§Ø² bestScore Ø­Ø³Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        alert("Ø®Ø±ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø§Ø² Ø§ÛŒÙ† Ø¨Ù‡ Ø¨Ø¹Ø¯ Ø§Ø­ØªÙ…Ø§Ù„ Ø§ÛŒÙ† Ù¾Ø§ÙˆØ±Ø¢Ù¾ Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
        setShopState(shop);
        updateShopUI();
      });
    });

    // Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ‡
    resetGameState(0);
    drawBackground();
    drawTank();
    applyLoadedState();
  </script>
</body>
</html>
